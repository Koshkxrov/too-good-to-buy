<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Your Order - Too Good To Buy</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Too Good To Buy">
    <meta name="theme-color" content="#ffffff">
    <meta name="msapplication-TileColor" content="#0e7c71">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon.PNG">
    <link rel="icon" type="image/png" sizes="32x32" href="icon.PNG">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.PNG">
    <link rel="manifest" href="manifest.webmanifest">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Pro Display', 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #F8F7F5;
            color: #1A1A1A;
            line-height: 1.5;
            min-height: 100dvh;
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100dvh;
        }
        
        .status-bar {
            height: 44px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            background: #F8F7F5;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-icons {
            display: flex;
            gap: 4px;
        }
        
        .signal-bar {
            width: 16px;
            height: 8px;
            background: black;
            border-radius: 2px;
        }
        
        .battery {
            width: 24px;
            height: 12px;
            border: 1px solid black;
            border-radius: 2px;
        }
        
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            background: white;
            border-bottom: none; /* no line under the title */
            position: relative; /* allow absolute centering of title */
        }
        
        .back-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-right: 16px;
        }
        
        .back-btn svg {
            width: 20px;
            height: 20px;
            color: #000000;
        }
        
        .header-title {
            flex: 1;
            text-align: center;
            font-size: 16px; /* smaller title */
            font-weight: 600; /* thinner */
            position: absolute;
            left: 50%;
            transform: translateX(-50%); /* perfectly centered regardless of back button */
        }
        
        .content {
            padding: 16px;
        }

        /* Safe area strip for iOS notch: white background above header */
        .safe-area-top {
            height: env(safe-area-inset-top, 44px);
            background: #ffffff;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        /* Make first card thinner than the second */
        .store-card { padding: 10px 14px; }
        .order-card { padding: 24px; }
        
        .logo {
            text-align: center;
            margin-bottom: 8px; /* tighter */
        }
        
        .logo-text {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo-upper {
            color: #8B4513;
        }
        
        .logo-crust {
            color: #FFD700;
        }
        
        .logo-underline {
            width: 64px;
            height: 2px;
            background: #FFD700;
            margin: 4px auto 0;
        }
        
        .store-logo-img {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            margin: 0 auto 8px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .store-logo-img img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }
        
        .store-name {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 4px;
        }
        
        .store-address {
            color: #666666;
            font-size: 13px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .find-store {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00796B;
            font-size: 13px;
            text-decoration: none;
        }
        
        .find-store svg {
            width: 16px;
            height: 16px;
            margin-left: 4px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding-bottom: 12px;
            font-weight: bold;
            color: #1A1A1A;
        }
        
        .tab.active {
            border-bottom: 2px solid #0F766E; /* match button green */
            color: #0F766E;
        }
        
        .tab.inactive {
            color: #666666;
            font-weight: normal;
        }
        
        .order-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .summary-section {
            display: flex;
            flex-direction: column;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666666;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        
        .summary-value {
            font-size: 14px;
            font-weight: 400; /* not bold */
        }
        
        .summary-value.bold {
            font-weight: 400; /* keep not bold */
        }
        
        .order-summary .summary-section:last-child {
            text-align: right;
            align-items: flex-end;
        }
        
        .packaging-note {
            font-size: 13px;
            color: #1A1A1A;
            line-height: 1.5;
        }

        .dotted-divider {
            border-top: 1px dashed #e5e7eb;
            margin: 16px 0 12px;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .collect-button {
            width: 100%;
            background: #0F766E;
            color: #ffffff;
            padding: 10px 16px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            min-height: 40px;
            margin: 0 auto;
        }
        .collect-button:hover { background: #0B615B; }
        
        .reminder-link {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00796B;
            font-size: 14px;
            text-decoration: none;
        }
        
        .reminder-link svg {
            width: 16px;
            height: 16px;
            margin-left: 8px;
        }
        
        .footer-suggestion { display: none; }

        /* Rating + Collected blocks */
        .rating-card {
            background: #2F7D6E;
            color: #fff;
            border-radius: 16px;
            padding: 24px 16px;
            text-align: center;
            margin-bottom: 16px;
        }
        .rating-title { font-weight: 700; margin-bottom: 16px; }
        .stars { display: flex; gap: 16px; justify-content: center; }
        .stars svg { width: 28px; height: 28px; color: #fff; }

        .collected-wrapper {
            border: 4px solid #0F4C45;
            border-radius: 16px;
            overflow: hidden;
        }
        .collected-header {
            background: #0F4C45;
            color: #fff;
            padding: 10px 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .collected-inner {
            background: #fff;
            padding: 16px;
        }
        .order-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            row-gap: 20px;
        }
        .grid-label { color: #7B8A8B; font-weight: 700; font-size: 14px; letter-spacing: 0.04em; }
        .grid-value { font-size: 18px; color: #1A1A1A; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 50;
        }
        
        .modal.show {
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #e2e8f0;
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-weight: 800;
            color: #1A1A1A;
            font-size: 20px;
            text-align: center;
            margin: 0 auto;
            transform: translateX(8px); /* nudge slightly right to visually center */
        }
        
        .close-button {
            color: #1A1A1A;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-weight: 800;
            font-size: 24px;
        }
        
        .modal-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 400px; /* Fixed height to prevent shrinking */
            position: relative; /* For absolute positioning of overlay */
        }
        
        .modal-center {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .quantity-label {
            font-size: 12px;
            color: #666666;
        }
        
        .quantity-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0F766E;
            color: #ffffff;
            font-weight: 700;
            font-size: 14px;
            margin: 0 auto 10px;
        }
        
        .item-name {
            font-weight: 700;
            color: #1A1A1A;
            font-size: 16px;
            margin: 4px 0 2px;
            text-align: center;
        }
        
        .store-info {
            color: #1A1A1A;
            font-size: 13px;
            margin: 0 0 10px;
            text-align: center;
        }
        
        .order-code-container {
            margin: 8px 0 6px; /* less bottom space to bring divider higher */
            text-align: center;
        }
        
        .order-code {
            display: inline-block;
            background: #0F766E;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            font-size: 16px;
            letter-spacing: 0.5px;
        }
        
        .divider-line {
            height: 1px;
            background: #E5E7EB;
            margin: 6px 0; /* raise line closer to the code */
        }
        
        .instructions {
            margin: 6px 0 8px; /* move higher and reduce bottom gap */
            text-align: center;
        }
        .instructions p {
            font-size: 14px; /* make text under the line bigger */
            line-height: 1.35;
        }
        
        .instructions p {
            color: #1A1A1A;
            font-size: 13px;
            line-height: 1.4;
            margin: 0;
        }
        
        
        .status-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #E0F2F1;
            color: #00796B;
            border: 1px solid rgba(0, 121, 107, 0.2);
            margin: 0 auto;
        }
        
        .status-icon svg {
            width: 24px;
            height: 24px;
        }
        
        .status-text {
            text-align: center;
            font-size: 12px;
            color: #666666;
        }
        
        .countdown {
            text-align: center;
            font-size: 12px;
            color: #666666;
            display: none;
        }
        
        .countdown.show {
            display: block;
        }
        
        /* Curtain-only swipe (no knob) */
        :root{
            --teal:#0F766E;     /* основной зелёный */
            --ink:#0F766E;      /* цвет текста и рамки */
            --bg:#FFFFFF;       /* фон */
        }
        .swipe-wrap{width:min(400px,80vw);margin:8px auto 0}
        .swipe-track{
            position:relative;height:60px;background:var(--bg);
            border-radius:9999px;overflow:hidden;user-select:none;touch-action:none;
            box-shadow:0 2px 8px rgba(0,0,0,.06); cursor:grab;
        }
        .swipe-track.dragging{ cursor:grabbing; }

        /* border that appears over everything */
        .swipe-track::before{
            content:"";position:absolute;inset:0;border:2px solid var(--ink);border-radius:9999px;pointer-events:none;z-index:4;
        }

        .swipe-fill{
            position:absolute;
            left:0; top:0; bottom:0;
            width:60px;                  /* just enough for the round tip */
            background:#0F766E;          /* teal */
            border-radius:9999px;        /* makes the tip perfectly round */
            display:flex;
            align-items:center;
            justify-content:flex-end;    /* position arrow at the tip (right edge) */
            padding-right:13px;          /* small inset from the edge (moved 5px left total) */
            z-index:1;
        }

        /* arrow itself */
        .chev-on-fill{
            width:32px; height:32px;
            pointer-events:none;
        }

        .swipe-text{
            position:absolute;inset:0;display:grid;place-items:center;z-index:2;
            font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);pointer-events:none;
            transform: translateX(12px); /* move text 12px to the right */
        }
        .swipe-track.done .swipe-text{ color:#fff }

        /* utility to hide nodes when success starts */
        .hidden{display:none !important}

        /* Overlay center animation */
        .demo-wrap{position:relative}
        .overlay-mini{position:absolute;left:50%;top:60%;transform:translate(-50%, -50%);width:60px;height:60px;
                      display:none;align-items:center;justify-content:center;z-index:10;pointer-events:none}
        .overlay-mini.show{display:flex}

        /* 1) Loader arc */
        .loader{width:60px;height:60px;opacity:0;transform:translateY(6px) scale(.96);
                transition:opacity .25s ease, transform .25s ease}
        .loader-arc{transform:rotate(-90deg);transform-origin:50% 50%}

        /* Base circle (ring + white inner ring) and stages */
        .ringBase{position:absolute;width:60px;height:60px;opacity:0;transform:scale(.9);
                  transition:opacity .22s ease, transform .22s ease}
        .ringOuter,.ringInner{position:absolute;border-radius:50%}
        .ringOuter{inset:0;border:3px solid var(--teal);background:transparent;will-change:transform,opacity}
        .ringInner{inset:10px;border:10px solid #fff}

        /* Fill-dot (center dot expands to fill inner circle) */
        .fillDot{position:absolute;left:50%;top:50%;width:44px;height:44px;background:var(--teal);
                 border-radius:50%;transform:translate(-50%,-50%) scale(0);opacity:1;
                 transition:transform .42s cubic-bezier(.2,.8,.2,1)}

        /* Halo (expanding ring that fades out) */
        .halo{position:absolute;left:50%;top:50%;width:60px;height:60px;border:3px solid var(--teal);
              border-radius:50%;transform:translate(-50%,-50%) scale(1);opacity:0;pointer-events:none}

        @keyframes haloExpand {
            0%   {transform:translate(-50%,-50%) scale(1);   opacity:.35;}
            100% {transform:translate(-50%,-50%) scale(1.35);opacity:0;}
        }
        @keyframes ringPulse {
            0% {transform:scale(1);}
            50%{transform:scale(1.08);}
            100%{transform:scale(1);}
        }
        @keyframes ringFadeOut {
            0%   {opacity:1; transform:scale(1);}
            100% {opacity:0; transform:scale(1.1);}
        }

        /* Check */
        .check{position:absolute;left:50%;top:50%;width:26px;height:26px;
               transform:translate(-50%,-50%) scale(.88);opacity:0;
               transition:opacity .22s ease, transform .22s ease}

        /* ДОБАВЬ это в CSS */
        .ring-gone .ringOuter,
        .ring-gone .ringInner{
          opacity:0 !important;
          display:none !important;
        }

        /* на всякий случай — чтобы ореол не «откатился» */
        .halo {
          animation-fill-mode: forwards;
        }

        /* если где-то был reflow — принудительно убираем stroke у SVG-лоадера */
        .loader.killed circle { stroke: transparent !important; opacity: 0 !important; }

        /* Success text */
        .success-text{position:absolute;left:50%;top:80%;transform:translate(-50%, -50%);text-align:center;opacity:0;transition:opacity .3s ease}
        .success-text.show{opacity:1}
        .success-title{font:600 18px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--teal);margin:0 0 8px 0}
        .success-instruction{font:400 14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#6B7280;margin:0;max-width:280px}

        /* no dimming of background on success per request */
        
        .swipe-instructions {
            margin-top: 8px;
            text-align: center;
            font-size: 12px;
            color: #666666;
        }
        
        .close-button-modal {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            background: white;
            color: #1A1A1A;
            cursor: pointer;
            display: none;
        }
        
        .close-button-modal.show {
            display: block;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="safe-area-top"></div>

        <!-- Header -->
        <header class="header">
            <button class="back-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 6l-6 6 6 6"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 12h16"/>
                </svg>
            </button>
            <h1 class="header-title" style="text-align:center;">Your order</h1>
            <div style="width: 12px;"></div>
        </header>

        <main class="content">
            <!-- Store Information Card -->
            <div class="card store-card">
                <!-- Store Logo -->
                <div class="logo" id="storeLogo">
                    <div class="store-logo-img" id="storeLogoImg" style="display: none;">
                        <img src="" alt="Store logo" id="storeLogoImage">
                    </div>
                    <div class="logo-text" id="defaultLogo">
                        <span class="logo-upper">Upper</span>
                        <span class="logo-crust">Crust</span>
                    </div>
                    <div class="logo-underline"></div>
                </div>
                
                <!-- Store Name -->
                <h2 class="store-name" id="storeName">Loading...</h2>
                
                <!-- Address -->
                <p class="store-address" id="storeAddress"></p>
                
                <!-- Find store link -->
                <a href="stores.html" class="find-store">
                    <span>Find store</span>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11a3 3 0 100-6 3 3 0 000 6z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 8c0 6.5-7.5 12-7.5 12S4.5 14.5 4.5 8a7.5 7.5 0 1115 0z"/>
                    </svg>
                </a>
            </div>

            <!-- Order Details Card -->
            <div class="card order-card">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active">I'm collecting</div>
                    <div class="tab inactive">Ask a friend</div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary" id="orderSummary">
                    <!-- Filled dynamically from selectedStore.items[0] if present -->
                </div>

                <!-- Packaging label + Note above dotted line -->
                <div class="summary-label" style="margin-top: 8px;">PACKAGING</div>
                <p class="packaging-note" id="packagingNote"></p>
                <div class="dotted-divider"></div>
                
            <!-- Action Buttons in same card -->
            <div class="action-buttons">
                <!-- Collect button -->
                <button id="collect-btn" onclick="showModal()" class="collect-button">
                    Tap to collect
                </button>
                
                <!-- Receive reminder button with bell icon -->
                <a href="#" class="reminder-link">
                    <span>Receive a reminder</span>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                </a>
            </div>
            </div>


            <!-- Footer Suggestion -->
            <div class="footer-suggestion">
                <h3 class="footer-title">SAME TIME, CLOSE BY!</h3>
            </div>
        </main>
    </div>

    <!-- Collection Modal -->
    <div id="collection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:none;">
                <div class="modal-title">Order to be collected</div>
                <button onclick="hideModal()" class="close-button" aria-label="Close dialog">✕</button>
            </div>

            <div class="modal-body">
                <div class="modal-center">
                    <div class="quantity-circle" id="modal-quantity">1x</div>
                    <div class="item-name" id="modal-item-name">Evening Bag</div>
                    <div class="store-info" id="modal-store-info">Upper Crust - Watford Junction</div>
                    <div class="order-code-container">
                        <span class="order-code" id="modal-order-code">F88GWNF3C87Q0</span>
                    </div>
                </div>

                <div class="divider-line"></div>

                <div class="instructions">
                    <p>Swipe below and show the order to the staff. Make sure to swipe only when you're in the store ready to collect your meal.</p>
                </div>

                <!-- ====== SWIPE TO COLLECT (curtain style) + success sequence ====== -->
                <div class="demo-wrap" id="screen">
                    <!-- Curtain-only swipe (no knob), round tip + arrow on the curtain -->
                    <div class="swipe-wrap">
                        <div class="swipe-track" id="swipeTrack" role="button" aria-label="Swipe to collect">
                            <!-- Curtain fill -->
                            <div class="swipe-fill" id="swipeFill">
                                <!-- Arrow directly on the curtain -->
                                <svg viewBox="0 0 24 24" class="chev-on-fill" aria-hidden="true">
                                    <path d="M9 6l6 6-6 6"
                                          fill="none"
                                          stroke="#FFFFFF"
                                          stroke-width="3.6"
                                          stroke-linecap="round"
                                          stroke-linejoin="round"/>
                        </svg>
                    </div>
                            <span class="swipe-text" id="swipeText">Swipe to collect</span>
                </div>
                </div>
                </div>

                <!-- Overlay center animation -->
                <div class="overlay-mini" id="overlay">
                    <!-- 1) loader arc -->
                    <svg class="loader" id="loader" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="34" fill="none" stroke="#0F766E" stroke-width="3" opacity="0.15"/>
                        <circle class="loader-arc" cx="50" cy="50" r="34" fill="none" stroke="#0F766E" stroke-width="3"
                                stroke-linecap="round" stroke-dasharray="215" stroke-dashoffset="215"/>
                    </svg>

                    <!-- 2–4) ring + fill + halo + check -->
                    <div class="ringBase" id="ringBase">
                        <div class="ringOuter"></div>          <!-- зелёный контур -->
                        <div class="ringInner"></div>          <!-- белое внутреннее кольцо -->
                        <div class="fillDot" id="fillDot"></div> <!-- точка, которая расширяется и заполняет -->
                        <div class="halo" id="halo"></div>     <!-- расходящееся кольцо-ореол -->
                        <svg class="check" id="check" viewBox="0 0 24 24">
                            <path d="M5 13l4 4 10-10" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>

                <!-- Success text -->
                <div class="success-text" id="successText">
                    <h2 class="success-title">Collection confirmed</h2>
                    <p class="success-instruction">Show this to the store staff to collect your meal!</p>
                </div>

                <button id="close-btn" onclick="hideModal()" class="close-button-modal">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Store data
        let selectedStore = null;
        const INLINE_DATA = JSON.parse(localStorage.getItem('INLINE_DATA') || '[]');

        // Load selected store data
        function loadStoreData() {
            const storeData = localStorage.getItem('selectedStore');
            if (storeData) {
                selectedStore = JSON.parse(storeData);
            } else {
                const realStores = localStorage.getItem('realStores');
                if (realStores) {
                    const stores = JSON.parse(realStores);
                    if (stores.length > 0) {
                        selectedStore = stores[0];
                        localStorage.setItem('selectedStore', JSON.stringify(selectedStore));
                    }
                }
            }
            updateStoreInfo();
        }

        // Update store information on the page
        function updateStoreInfo() {
            if (!selectedStore) return;

            // Update logo - show real logo if available
            const storeLogoImg = document.getElementById('storeLogoImg');
            const storeLogoImage = document.getElementById('storeLogoImage');
            const defaultLogo = document.getElementById('defaultLogo');
            
            if (selectedStore.logo) {
                // Show real logo
                storeLogoImage.src = selectedStore.logo;
                storeLogoImage.alt = `${selectedStore.name} logo`;
                storeLogoImg.style.display = 'flex';
                defaultLogo.style.display = 'none';
                
                // Handle image load error
                storeLogoImage.onerror = function() {
                    storeLogoImg.style.display = 'none';
                    defaultLogo.style.display = 'block';
                    defaultLogo.innerHTML = selectedStore.name.charAt(0);
                };
            } else {
                // Show text logo
                storeLogoImg.style.display = 'none';
                defaultLogo.style.display = 'block';
                defaultLogo.innerHTML = selectedStore.name.charAt(0);
            }

            // Update store name and address
            const storeNameElement = document.getElementById('storeName');
            storeNameElement.textContent = selectedStore.name || selectedStore.shortName || '';
            const addressElement = document.getElementById('storeAddress');
            addressElement.textContent = selectedStore.address || selectedStore.location || '';

            // Fill order summary from first available item if exists
            const orderSummary = document.getElementById('orderSummary');
            orderSummary.innerHTML = '';
            const first = (selectedStore.items && selectedStore.items[0]) || null;
            if (first) {
                const LOCALE = 'en-GB';
                const quantity = (first.items_available || first.quantity || 1);
                const col1 = document.createElement('div');
                col1.className = 'summary-section';
                const dateLabel = document.createElement('div');
                dateLabel.className = 'summary-label';
                dateLabel.textContent = 'DATE';
                const dateValue = document.createElement('div');
                dateValue.className = 'summary-value';
                const interval = first.pickup_interval;
                const start = interval && interval.start ? new Date(interval.start) : null;
                dateValue.textContent = start ? start.toLocaleDateString(LOCALE, { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                const bagLabel = document.createElement('div');
                bagLabel.className = 'summary-label';
                bagLabel.style.marginTop = '16px';
                bagLabel.textContent = 'SURPRISE BAG';
                const bagValue = document.createElement('div');
                bagValue.className = 'summary-value';
                bagValue.textContent = `${quantity}x ${first.name || 'Bag'}`;
                col1.appendChild(dateLabel);
                col1.appendChild(dateValue);
                col1.appendChild(bagLabel);
                col1.appendChild(bagValue);

                const col2 = document.createElement('div');
                col2.className = 'summary-section';
                const timeLabel = document.createElement('div');
                timeLabel.className = 'summary-label';
                timeLabel.textContent = 'COLLECTION TIME';
                const timeValue = document.createElement('div');
                timeValue.className = 'summary-value bold';
                const end = interval && interval.end ? new Date(interval.end) : null;
                const fmt = d => d ? d.toLocaleTimeString(LOCALE, { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
                timeValue.textContent = `${fmt(start)} - ${fmt(end)}`;

                const totalLabel = document.createElement('div');
                totalLabel.className = 'summary-label';
                totalLabel.style.marginTop = '16px';
                totalLabel.textContent = 'TOTAL';
                const totalValue = document.createElement('div');
                totalValue.className = 'summary-value bold';
                if (typeof first.price === 'number') {
                    const total = first.price * quantity;
                    totalValue.textContent = `£${total.toFixed(2)}`;
                } else {
                    totalValue.textContent = '';
                }
                col2.appendChild(timeLabel);
                col2.appendChild(timeValue);
                col2.appendChild(totalLabel);
                col2.appendChild(totalValue);

                orderSummary.appendChild(col1);
                orderSummary.appendChild(col2);
            }

            // Packaging note
            const packagingNote = document.getElementById('packagingNote');
            packagingNote.textContent = 'The store will provide packaging for your food, but we encourage you to bring your own bag to carry it home in.';
        }

        // Timer functionality
        // No countdown on the button; show static action text

        // Load store data when page loads
        document.addEventListener('DOMContentLoaded', loadStoreData);

        // Back button
        document.querySelector('.back-btn').addEventListener('click', function() {
            if (document.referrer) { history.back(); } else { window.location.href = 'home.html'; }
        });

        // Simple JavaScript for modal and swipe functionality
        function showModal() {
            // Update modal with dynamic data
            const selectedStore = JSON.parse(localStorage.getItem('selectedStore') || 'null');
            const firstItem = selectedStore && selectedStore.items && selectedStore.items[0] ? selectedStore.items[0] : null;
            
            // Update quantity
            const quantity = firstItem ? (firstItem.items_available || firstItem.quantity || 1) : 1;
            document.getElementById('modal-quantity').textContent = quantity + 'x';
            
            // Update item name
            const itemName = firstItem ? (firstItem.name || 'Bag') : 'Bag';
            document.getElementById('modal-item-name').textContent = itemName;
            
            // Update store info
            const storeName = selectedStore ? (selectedStore.name || 'Store') : 'Store';
            document.getElementById('modal-store-info').textContent = storeName;
            
            // Update order code (you can make this dynamic if needed)
            document.getElementById('modal-order-code').textContent = 'F88GWNF3C87Q0';
            
            console.log('Modal updated with:', { quantity, itemName, storeName });
            // Dim the header/top area too while modal is open
            document.querySelector('.header').style.filter = 'brightness(0.92)';
            
            document.getElementById('collection-modal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('collection-modal').classList.remove('show');
            document.querySelector('.header').style.filter = '';
        }

        // Curtain-only swipe (no knob), round tip + arrow on the curtain
        (function(){
            const track  = document.getElementById('swipeTrack');
            const fill   = document.getElementById('swipeFill');
            const text   = document.getElementById('swipeText');
            const chev   = document.getElementById('chevOnFill');

            const trackH = 60;            // track height
            const insetB = 2;             // visual border inset used for mask
            const successPct = 0.88;

            let dragging=false, startX=0, startW=0;

            const maxW  = ()=> track.clientWidth;               // full width of track
            const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));

            // place curtain: set width (arrow is centered automatically via flexbox)
            function setCurtain(w){
                const W = clamp(w, trackH, maxW()); // ensure minimum width is track height
                fill.style.width = W + 'px';
            }

            function down(e){
                if(track.classList.contains('done')) return;
                dragging = true;
                track.classList.add('dragging');
                const pt = e.touches ? e.touches[0] : e;
                const r  = track.getBoundingClientRect();
                startX   = pt.clientX;
                startW   = parseFloat(getComputedStyle(fill).width);
                // if tapped to the right of the tip, pick it up from there
                const edge = r.left + startW;
                if(pt.clientX > edge){ startW = pt.clientX - r.left; setCurtain(startW); startX = pt.clientX; }
            e.preventDefault();
        }

            function move(e){
                if(!dragging) return;
                const pt = e.touches ? e.touches[0] : e;
                const dx = pt.clientX - startX;
                setCurtain(startW + dx);
            }

            function up(){
                if(!dragging) return;
                dragging=false;
                track.classList.remove('dragging');
                const W = parseFloat(getComputedStyle(fill).width);
                if(W / maxW() >= successPct){
                    setCurtain(maxW());
                    track.classList.add('done');
                    text.textContent = 'Collected';
                    try{ navigator.vibrate && navigator.vibrate(10);}catch{}
                    startFinalSequence();
                }else{
                    // snap back to initial round "button" look
                    setCurtain(trackH); // старт как круглый носик
                }
            }

            // init: start with round tip look (curtain width ~= track height)
            setCurtain(trackH);

            // events
            track.addEventListener('mousedown', down);
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup',   up);

            track.addEventListener('touchstart', down, {passive:false});
            document.addEventListener('touchmove', move, {passive:false});
            document.addEventListener('touchend',  up);

            // Final sequence (arc → fill → pulse+halo → check)
            function startFinalSequence(){
                const overlay  = document.getElementById('overlay');
                const loader   = document.getElementById('loader');
                const arc      = loader.querySelector('.loader-arc');
                const ringBase = document.getElementById('ringBase');
                const ringOuter= ringBase.querySelector('.ringOuter');
                const fillDot  = document.getElementById('fillDot');
                const halo     = document.getElementById('halo');
                const check    = document.getElementById('check');

                // Hide swipe bar and instructions immediately
                document.querySelector('.swipe-wrap')?.classList.add('hidden');
                document.querySelector('.instructions')?.classList.add('hidden');

                overlay.classList.add('show');

                // 1) arc 0→100% (faster)
                requestAnimationFrame(()=>{ loader.style.opacity='1'; loader.style.transform='translateY(0) scale(1)'; });
                let start=null; const total=215, durArc=400;
                function tick(ts){
                    if(!start) start=ts;
                    const p=Math.min(1,(ts-start)/durArc);
                    arc.style.strokeDashoffset = String(total*(1-p));
                    if(p<1) requestAnimationFrame(tick);
                }
                requestAnimationFrame(tick);

                // 2) show ring + inner white ring; grow fillDot to fill inner circle (faster)
                setTimeout(()=>{
                    loader.style.opacity='0'; loader.style.transform='translateY(-6px) scale(.96)';
                    loader.classList.add('killed');      // чтобы stroke исчез
                    loader.style.display = 'none';       // и не мешал визуально
                    ringBase.style.opacity='1'; ringBase.style.transform='scale(1)';
                    fillDot.style.transform = 'translate(-50%,-50%) scale(1)';
                }, durArc + 80);

                // 3) pulse ring, emit halo, then remove BOTH rings for good (faster)
                setTimeout(() => {
                    const ringInner = ringBase.querySelector('.ringInner');

                    // пульс ИМЕННО зелёного контура (не контейнера) - faster
                    ringOuter.style.animation = 'ringPulse 200ms ease';

                    // ореол — расширяется и растворяется, и не откатывается - faster
                    halo.style.animation = 'haloExpand 300ms ease forwards';
                    halo.style.opacity = '1';

                    // после пульса — плавное исчезновение зелёного кольца - faster
                    setTimeout(() => {
                        ringOuter.style.animation = 'ringFadeOut 300ms ease forwards';
                    }, 200);

                    const finallyKillRings = () => {
                        // помечаем контейнер как избавившийся от колец
                        ringBase.classList.add('ring-gone');

                        // на всякий — жёстко убираем оба элемента
                        if (ringOuter) { ringOuter.style.opacity = '0'; ringOuter.style.display = 'none'; }
                        if (ringInner) { ringInner.style.opacity = '0'; ringInner.style.display = 'none'; }

                        // и SVG-лоадер тоже больше не виден
                        loader.classList.add('killed');
                        loader.style.display = 'none';
                    };

                    // слушатели конца анимации (Chrome/Firefox/Safari)
                    const onFadeEnd = (e) => {
                        if (e.animationName === 'ringFadeOut') {
                            ringOuter.removeEventListener('animationend', onFadeEnd);
                            ringOuter.removeEventListener('webkitAnimationEnd', onFadeEnd);
                            finallyKillRings();
                        }
                    };
                    ringOuter.addEventListener('animationend', onFadeEnd);
                    ringOuter.addEventListener('webkitAnimationEnd', onFadeEnd);

                    // ФОЛБЭК на случай, если событие не придёт (старый Safari и т.п.) - faster
                    setTimeout(finallyKillRings, 600);

                    // 4) чек появляется параллельно
                    check.style.opacity = '1';
                    check.style.transform = 'translate(-50%,-50%) scale(1)';

                    // 5) показать текст успеха
                    setTimeout(() => {
                        document.getElementById('successText').classList.add('show');
                    }, 200);
                }, durArc + 80 + 300);

                // (опционально) скрыть overlay через N мс:
                // setTimeout(()=> overlay.classList.remove('show'), 1800);
            }
        })();

        // Close modal when clicking outside
        document.getElementById('collection-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>